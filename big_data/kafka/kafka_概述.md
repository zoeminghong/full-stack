# Kakfa

Kafka 是**高吞吐量**、分布式的发布-订阅消息系统。支持水平拓展、多语言开发方式。其定位为一个分布式流式处理平台。

## 名词解释

AR：所有副本（包括 Leader 副本）分区集合。

ISR：所有与 Leader 副本保持数据同步的副本（包括 Leader 副本）分区集合。

OSR：与 Leader 副本数据存在同步滞后的分区集合。

HW：它标示了一个特定的消息偏移量，消费者只能拉取到这个 offset **之前**的消息。

LEO：它标示当前日志文件中下一条待写入消息的 offset，LEO 的大小相当于当前日志分区中最后一条消息的 offset 值加 1。

## 基本概念

### Partition 分区

每个主题在创建的过程中，会被分成**一个或多个**分区，每个分区是由一系列**有序的、不可变**的消息组成。

#### 意义

分区实现了负载均衡，保证 Kafka 的高吞吐。理论上来说，分区数越多，Kafka 吞吐量越高。分区保证了在同一个分区下的有序性，但不能保证跨分区的有序。

#### 物理

// Todo 存放路径

每个分区对应一个文件夹，分区命名规则：主题名称—分区编号（从0开始）。数据在分区中是顺序写磁盘，因而效率非常高。

#### 消息的有序性是如何保证的

Kafka分布式的单位是partition，同一个partition用一个write ahead log组织，所以可以保证FIFO的顺序。

[kafka的topic多分区的情况，如何保证跨区的消息消费的顺序性](https://oracle-api.iteye.com/blog/2383793)

#### 配置与修改

如何实现负载均衡？

### Replica 副本

每个分区存在一个或多个副本，分区的副本分布在集群的不同代理商，**以提高可用性**。

副本数能大于broker数吗

#### Leader 副本

负责处理客户端读/写请求

#### Follower 副本

从 Leader 副本同步数据

> 这种主从模式保证了数据的一致性和有序性

// 分区副本Leader 如何进行选举

//当leader 出现异常的时候，Follower如何保证数据不丢失

### 日志段

一个日志又被划分为多个日志段，日志段是 Kafka 日志对象分片的最小单位。一个日志段对应磁盘上一个具体的日志文件和两个索引文件。

日志文件为以 ”.log“ 结尾的数据文件，保存实际数据

两个索引文件分别为：”.index“ 和 ”.timeindex“ 结尾，表示**消息偏移量索引文件**和**消息时间戳索引文件**。

// 日志对象如何进行分片

// 消息时间戳索引文件有什么用

### 消费者

在 Kafka 中每一个消费者都属于一个特定的消费组（groupId），如果不指定消费组，默认为：`test-consumer-group` ，同时消费者会有一个全局唯一的id，通过 `client.id` 进行配置，如果没有指定消费者ID，默认为：`${groupId}-${hostName}-${timestamp}-${UUID前8位}`

- 一个 Topic 中的一条消息，在同一个消费组中消费一次（消费组可以理解为线程池，消费者可以理解为一个线程）
- 不同的消费组，可以同时消费消息

#### 一个消费组中存在多个消费者，如何保证消费组在消费数据的时候的数据有序性？

通过一个消费组中，不同的消费者是分别消费不同的分区数据，也就是说同一个 Topic 中的每一个分区对应一个消费组。

[Kafka常见问题总结](https://yezhwi.github.io/bigdata/2018/05/25/Kafka%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93/)

## 基本信息

### 日志目录

Kafka 在安装完成之后，其服务器日志目录为 `$KAFKA_HOME/logs` ，该目录下存在一个 `server.log` 。

### 选举场景

- 分区副本选举 Leader
- 消费者组选举 Leader
- 控制器选举 Leader

## 优势

Kafka 不会立即删除已被消费的消息，支持基于消息已存储的时间长度和基于分区大小的两种策略进行数据过期删除。



副本状态问题，Parition状态信息都保存在哪里，怎么进行更新

当生产者发送消息的时候，leader副本不存在，或者还在选举中，会怎么做

如果缓存的状态机信息与实际不符，如何进行手动更新