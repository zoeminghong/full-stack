关键字：服务认证、服务网格

service mesh定义就是“它是一个专用的基础设施层，使得服务间的通信安全、高效和可靠”。

从过去几年发布的大量开源项目中我们可以总结出谷歌内部构建、部署与管理大型分布式容器化应用的方案。而Istio就是这个方案的最后一步——管理应用程序。

Istio 主要方向是在安全和流量管理功能上。Istio把[Envoy代理](https://www.envoyproxy.io/)作为每个 pod 的 sidecar 运行并通过 Istio 的控制平面来动态的配置Envoy 从而实现混沌工程实践以及故障注入、熔断、限流和链路跟踪等概念。

利用基于 Envoy 的 sidecar 机制，Istio **无需修改应用代码**就可以完成嵌入。Envoy 代理容器的所有网络流量，而 Istio 的控制平面可以**动态配置 Envoy 的策略**。因此 Istio 可以在对应用透明的前提下提供诸如 **TLS 双向验证、限流和熔断**等功能。

### 能力

- 流量管理
- 可观察性
- 强制策略
- 服务身份标识和安全

### 流量控制

#### 自动负载均衡

支持 HTTP、gRPC、WebSocket 和 TCP 流量的自动负载均衡。

### 可观测性

#### 遥感

Istio 可以自动生成遥测平面，无需额外工具就能生成统一的应用指标数据和链路追踪数据。

### 强制策略

### 服务身份标识和安全

#### 双向 TLS

Istio可以在不修改应用的前提下，为服务间调用配置双向 TLS 认证。 主要针对通信方面，将明文传输的服务通信，转换为 Envoy 之间的加密通信。这一安全设置可以在全局、Namespace 或者单个服务的范围内生效。

#### 黑白名单

Istio 支持基于属性或者 IP 的白名单和黑名单。

#### 角色访问控制

Istio 支持基于角色的访问控制（RBAC），为 Istio 网格中的服务提供**命名空间级别、服务级别和方法级别**的访问控制。

- **基于角色的语义**，简单易用。
- **服务间和最终用户对服务的授权**。
- **通过自定义属性支持的灵活性**，例如条件、角色和角色绑定。
- **高性能**，因为 Istio 授权是在 Envoy 本地强制执行的。
- **高兼容性**，原生支持 HTTP、HTTPS 和 HTTP2，以及任意普通 TCP 协议。

#### 服务认证

就像系统通过用户认证来验证用户身份一样，服务也可以像用户一样做认证。我们可以在服务之间建立基于角色的访问控制（RBAC），还能更细粒度的规范服务在网络中的行为。

## 组件

- **Pilot:** 管理和维护所有的Envoy代理中的各种路由规则和RBAC配置。
- **Mixer:** 进行遥测数据采集和执行访问控制/使用策略。
- **Citadel:** 负责颁发和更新TLS证书。
- **Galley:** 它和用户关系不大，主要负责收集和验证系统其他组件的用户配置。
- **Proxy:** Envoy作为每个Kubernetes pod的sidecar代理运行可以提供动态服务发现，负载均衡，TLS认证，RBAC，HTTP和gRPC代理，熔断，健康检查，滚动更新，故障注入和遥测数据。
- **Gateway:** 网关可以作为集群ingress或egress的负载均衡边缘代理。ingress规则可以通过路由规则进行配置。

### Envoy

Envoy 是代理组件的一种具体实现，代理容器的所有网络流量，可以提供动态服务发现，负载均衡，TLS认证，RBAC，HTTP和gRPC代理，熔断，健康检查，滚动更新，故障注入和遥测数据。

## Istio 应用

### Istio的优势

- **开箱即用的微服务遥测** 微服务能够通过Istio自动生成遥测平面，无需额外工具就能生成统一的应用指标数据和链路追踪数据。
- **双向TLS** Istio可以在不修改应用的前提下，为服务间调用配置双向TLS认证。 集群内的CA能够为Envoy代理提供必要的证书以保护服务间的流量。
- **红黑部署** 通过在部署期间动态分配应用程序的新老版本之间的流量，我们可以一边观察集群的报错情况，一边将新版本应用逐渐部署到生产环境。
- **丰富的网络策略** 使用Kubernetes我们可以为它的API接口和服务间的网络策略提供RBAC认证。而Istio不仅可以做RBAC认证，它的认证粒度还能限制到HTTP协议的方法和资源路径。同时，支持重试、故障转移和故障注入对流量行为进行细粒度控制。

### 落地Istio过程中的经验

想要 Istio 发挥强大的作用，需要良好的微服务架构设计，不过，无论是传统的单体应用还是微服务，都能从 Istio 中获益。

提高可观察性有助于解决微服务设计中的问题。在迁移、重构或整合项目时使用Istio是有好处的，而在设计良好的微服务项目环境中使用，会让Istio大放异彩。 但请记住，增加任何组件都会增加系统的复杂度。

### Istio 与 Hystrix 对比

Istio区别于Hystrix，它采用服务网格的设计方案。因此落地和运维都变得更加简单。Istio为服务无感知的增加了流量控制和安全性，如果想发挥它的最大效益，还需要设计良好的微服务架构。即使是非常老旧的项目也能在Istio的遥测技术和安全性上获益。

## 参考

[Istio——企业级微服务解决方案](https://www.servicemesher.com/blog/istio-kubernetes-service-mesh/)

[Istio 文档](https://preliminary.istio.io/zh/docs/)

